<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
      integrity="sha384-xewr6kSkq3dBbEtB6Z/3oFZmknWn7nHqhLVLrYgzEFRbU/DHSxW7K3B44yWUN60D"
      crossorigin="anonymous"
    />
    <title>Paternoster</title>
  </head>
  <body>
    <div class="col-lg-8 p-3">
      <h2>Paternoster</h2>
      <div class="ui-widget">
        <label for="station">Select station </label>
        <input id="station" />
      </div>
      <div id="lifts"></div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js"
      integrity="sha384-skAcpIdS7UcVUC05LJ9Dxay8AXcDYfBJqt1CJ85S/CFujBsIzCIv+l9liuYLaMQ/"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-1.12.4.min.js"
      integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
      integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
      crossorigin="anonymous"
    ></script>
    <script>
      function refreshLifts(station) {
        if (station === undefined) {
          station = document.getElementById("station").value;
        }
        console.log(station);
        $.getJSON(
          "getlifts",
          { station: station },
          function (data, status, xhr) {
            const liftsElement = document.getElementById("lifts");
            while (true) {
              const child = liftsElement.firstChild;
              if (child === null) {
                break;
              }
              console.log("removing", child);
              liftsElement.removeChild(child);
            }
            if (data.length === 0) {
              liftsElement.innerText = "No broken lifts for " + station;
              liftsElement.appendChild(document.createElement("br"));
            } else {
              const message = document.createElement("span");
              message.innerText = "Issues with lifts at";
              liftsElement.appendChild(message);
              const liftList = document.createElement("ul");
              for (const lift of data) {
                const item = document.createElement("li");
                item.innerText = lift["location"];
                if (lift["message"] != "Unknown") {
                  item.innerText += " - " + lift["message"];
                }
                liftList.appendChild(item);
              }
              liftsElement.appendChild(liftList);
            }
            const button = document.createElement("button");
            button.setAttribute("type", "button");
            button.setAttribute("class", "btn btn-primary");
            button.setAttribute("onClick", "javascript:refreshLifts()");
            button.innerHTML = "Refresh lifts list";
            liftsElement.appendChild(button);
          }
        );
      }
      $(function () {
        var cache = {};
        $("#station").autocomplete({
          minLength: 2,
          source: function (request, response) {
            var term = request.term;
            if (term in cache) {
              response(cache[term]);
              return;
            }
            $.getJSON("getstations", request, function (data, status, xhr) {
              cache[term] = data;
              response(data);
            });
          },
          select: function (event, ui) {
            refreshLifts(ui.item.value);
          },
        });
      });
    </script>
  </body>
</html>
